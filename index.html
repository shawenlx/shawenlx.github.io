<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="I love code and share.">
<meta property="og:type" content="website">
<meta property="og:title" content="Shawenlx">
<meta property="og:url" content="/index.html">
<meta property="og:site_name" content="Shawenlx">
<meta property="og:description" content="I love code and share.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shawenlx">
<meta name="twitter:description" content="I love code and share.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="/"/>





  <title> Shawenlx </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Shawenlx</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="/2016/12/01/『Hexo』使用Hexo搭建GitHub博客/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Liuxi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Shawenlx">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Shawenlx" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/01/『Hexo』使用Hexo搭建GitHub博客/" itemprop="url">
                  『Hexo』使用Hexo搭建GitHub博客
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-01T09:15:38+08:00">
                2016-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/daily/" itemprop="url" rel="index">
                    <span itemprop="name">daily</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/01/『Hexo』使用Hexo搭建GitHub博客/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/01/『Hexo』使用Hexo搭建GitHub博客/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="『Hexo』使用Hexo搭建GitHub博客"><a href="#『Hexo』使用Hexo搭建GitHub博客" class="headerlink" title="『Hexo』使用Hexo搭建GitHub博客"></a>『Hexo』使用Hexo搭建GitHub博客</h1><hr>
<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>​   谈起这个博客的由来，真的挺不容易的。一年前兴奋地买了域名，后来因为很多东西都不具备实现这个模版博客的能力，遂搁置了域名，选择了简书。有点笨，这一次也折腾了两三个晚上，总算把它搭建起来了。</p>
<hr>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>git搭建 ：<a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/" target="_blank" rel="external">git教程</a></li>
<li>node.js :  <a href="http://nodejs.org/download/" target="_blank" rel="external">node.js download</a></li>
<li>git主要用于将代码同步到GitHub平台，node.js主要用到了npm这个包管理器，方便我们快速搭建Hexo环境。</li>
<li>个人的主机环境为：MacOS</li>
</ul>
<hr>
<h3 id="注册Github"><a href="#注册Github" class="headerlink" title="注册Github"></a>注册Github</h3><ul>
<li>我们的主要目的就是把本地的静态网站托管到GitHub这个平台上。</li>
<li><strong>Tips: 我遇到的一个坑就是，我用的是QQ邮箱注册，GitHub验证邮件被拦截了，貌似163邮箱也会拦截。一定要验证邮箱，否则即使你博客搭建好了，托管到GitHub上面，也会一直404无法打开。</strong></li>
</ul>
<hr>
<h3 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h3><ul>
<li>安装Hexo</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo npm install hexo-cli -g</div></pre></td></tr></table></figure>
<p>Hexo官方文档：<a href="https://hexo.io/" target="_blank" rel="external">Hexo</a></p>
<ul>
<li>利用Hexo初始化一个博客文件夹</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo init [文件夹]</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://docs.npmjs.com/cli/install" target="_blank" rel="external"><code>npm install</code></a> 命令用来安装模块到<code>node_modules</code>目录。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> [文件夹]            //进入到博客文件夹</div><div class="line">npm install           //利用npm install命令安装模块node_modules</div></pre></td></tr></table></figure>
<p>关于npm的详细使用，参照文档，或者<a href="http://www.ruanyifeng.com/blog/2016/01/npm-install.html" target="_blank" rel="external">npm 模块安装机制简介</a>。</p>
<p>至此，一个博客已经搭建好了，但是我们还没办法看到它。接下来就利用Hexo命令来启动我们的博客。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo g              //利用Hexo 生成静态页面</div><div class="line">hexo s              //启动本地服务</div></pre></td></tr></table></figure>
<p>你一定迫不及待想看看这个东西给你带来了什么样的惊喜。打开浏览器，<a href="http://localhost:4000，你就可以看到一个模版博客已经出现在你面前了，虽然这不是你最终想要的，不过也算是让我们眼前一亮。" target="_blank" rel="external">http://localhost:4000，你就可以看到一个模版博客已经出现在你面前了，虽然这不是你最终想要的，不过也算是让我们眼前一亮。</a></p>
<p>命令倒是执行了几个了，但是我们不知道它到底做了些什么。先来看看吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ls      //查看文件目录， 当然一些隐藏文件无法查看， 没关系，ls -al即可。</div></pre></td></tr></table></figure>
<p>暂时忽略其他文件是干什么的，先看看 <code>_config.yml</code>，这是我博客的设置。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Hexo Configuration</span></div><div class="line"><span class="comment">## Docs: https://hexo.io/docs/configuration.html</span></div><div class="line"><span class="comment">## Source: https://github.com/hexojs/hexo/</span></div><div class="line"></div><div class="line"><span class="comment"># Site</span></div><div class="line">title: Shawenlx                             <span class="comment">#博客标题</span></div><div class="line">subtitle:                                   <span class="comment">#副标题</span></div><div class="line">description: I love code and share.         <span class="comment">#个人描述</span></div><div class="line">author: Liuxi                               <span class="comment">#作者名</span></div><div class="line">language: en                                <span class="comment">#站点语言，如果是中文，把en替换成zh-CN</span></div><div class="line">timezone:                                   <span class="comment">#同步时区</span></div><div class="line"></div><div class="line"><span class="comment"># URL</span></div><div class="line">url: /</div><div class="line">root: /</div><div class="line">permalink: :year/:month/:day/:title/</div><div class="line">permalink_defaults:</div><div class="line"></div><div class="line"><span class="comment"># Directory 文件目录对应生成的文件夹目录</span></div><div class="line">source_dir: <span class="built_in">source</span></div><div class="line">public_dir: public</div><div class="line">tag_dir: tags</div><div class="line">archive_dir: archives</div><div class="line">category_dir: categories</div><div class="line">code_dir: downloads/code</div><div class="line">i18n_dir: :lang</div><div class="line">skip_render:</div><div class="line"></div><div class="line"><span class="comment"># Writing</span></div><div class="line">new_post_name: :title.md <span class="comment"># File name of new posts</span></div><div class="line">default_layout: post</div><div class="line">titlecase: <span class="literal">false</span> <span class="comment"># Transform title into titlecase</span></div><div class="line">external_link: <span class="literal">true</span> <span class="comment"># Open external links in new tab</span></div><div class="line">filename_case: 0</div><div class="line">render_drafts: <span class="literal">false</span></div><div class="line">post_asset_folder: <span class="literal">false</span></div><div class="line">relative_link: <span class="literal">false</span></div><div class="line">future: <span class="literal">true</span></div><div class="line">highlight:                      <span class="comment">#代码高亮</span></div><div class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></div><div class="line">  line_number: <span class="literal">true</span></div><div class="line">  auto_detect: <span class="literal">false</span></div><div class="line">  tab_replace:</div><div class="line"></div><div class="line"><span class="comment"># Category &amp; Tag</span></div><div class="line">default_category: uncategorized</div><div class="line">category_map: categories</div><div class="line">tag_map:</div><div class="line"></div><div class="line"><span class="comment"># Date / Time format</span></div><div class="line"><span class="comment">## Hexo uses Moment.js to parse and display date</span></div><div class="line"><span class="comment">## You can customize the date format as defined in</span></div><div class="line"><span class="comment">## http://momentjs.com/docs/#/displaying/format/</span></div><div class="line">date_format: YYYY-MM-DD</div><div class="line">time_format: HH:mm:ss</div><div class="line"></div><div class="line"><span class="comment"># Pagination    </span></div><div class="line"><span class="comment">## Set per_page to 0 to disable pagination 设置分页</span></div><div class="line">per_page: 10</div><div class="line">pagination_dir: page</div><div class="line"></div><div class="line"><span class="comment"># Extensions</span></div><div class="line">theme: next                 <span class="comment">#主题模版，搜索 ./themes 文件夹下的主题，此处我用的NexT模版</span></div><div class="line"></div><div class="line"><span class="comment"># Deployment</span></div><div class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></div><div class="line">deploy:</div><div class="line">  <span class="built_in">type</span>: git</div><div class="line">  repo: https://github.com/shawenlx/shawenlx.github.io.git</div><div class="line">  branch: master</div></pre></td></tr></table></figure>
<p><strong>Tips</strong>: 当我们着手修改这个文件的时候，字段名以及<code>:</code>后面，切记一定要加<strong>一个空格！</strong>我一开始也遇到这个问题，执行<code>hexo g</code>命令的时候，就会报错提示我<code>_config.yml</code>文件无法解析。</p>
<hr>
<h3 id="将博客托管到Github平台"><a href="#将博客托管到Github平台" class="headerlink" title="将博客托管到Github平台"></a>将博客托管到Github平台</h3><ul>
<li>创建一个GitHub仓库，<a href="https://github.com/new" target="_blank" rel="external"><code>new repository</code></a></li>
<li>在 <em>Repository name</em> 栏中，输入 <code>your user name.github.io</code>，譬如我的GitHub用户名是shawenlx，所以就建立工程名为：<a href="https://github.com/shawenlx/shawenlx.github.io" target="_blank" rel="external"><code>shawenlx.github.io</code></a></li>
<li>配置好本地的SSH Key。</li>
<li>拥有了个人的GitHub Pages后，再回到Hexo的<code>_config.yml</code>文件, 参照我的配置保存即可。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">deploy:</div><div class="line">  <span class="built_in">type</span>: git</div><div class="line">  repo: https://github.com/shawenlx/shawenlx.github.io.git</div><div class="line">  branch: master</div></pre></td></tr></table></figure>
<ul>
<li>最后利用hexo命令，将博客推送到Github上。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo clean              <span class="comment">#推送前，先清除下本地数据库，防止缓存导致上传不成功</span></div><div class="line">hexo d -g               <span class="comment">#利用这个组合命令，将博客上传到github上。</span></div></pre></td></tr></table></figure>
<ul>
<li>当你打开浏览器，输入<code>your_user_name.github.io</code>，就可以看到你托管到平台上的数据了。</li>
</ul>
<hr>
<h3 id="关于博客主题模版"><a href="#关于博客主题模版" class="headerlink" title="关于博客主题模版"></a>关于博客主题模版</h3><ul>
<li>网上有各种各样的模版，我用的<a href="http://theme-next.iissnan.com/" target="_blank" rel="external">NexT</a>, 参照官方文档进行配置就可以了。目前博客还在完善，特此记录本博客的搭建经历。</li>
</ul>
<hr>
<h3 id="关于管理博客内容"><a href="#关于管理博客内容" class="headerlink" title="关于管理博客内容"></a>关于管理博客内容</h3><ul>
<li>参照<a href="https://hexo.io/" target="_blank" rel="external">Hexo官方文档</a></li>
</ul>
<hr>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>以后简书会同步更新这个博客的内容。</p>
<p><strong>复习本博客链接：<a href="shawenlx.github.io">shawenlx.github.io</a></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="/2016/11/27/UITableView-FDTemplateLayoutCell-源码探究/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Liuxi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Shawenlx">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Shawenlx" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/27/UITableView-FDTemplateLayoutCell-源码探究/" itemprop="url">
                  UITableView+FDTemplateLayoutCell 源码探究
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-27T13:53:00+08:00">
                2016-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source-code/" itemprop="url" rel="index">
                    <span itemprop="name">source_code</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/27/UITableView-FDTemplateLayoutCell-源码探究/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/27/UITableView-FDTemplateLayoutCell-源码探究/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="UITableView-FDTemplateLayoutCell-源码探究"><a href="#UITableView-FDTemplateLayoutCell-源码探究" class="headerlink" title="UITableView+FDTemplateLayoutCell 源码探究"></a>UITableView+FDTemplateLayoutCell 源码探究</h2><hr>
<ul>
<li>在我们日常的业务中，常常伴随大量的UITableView，然而动态地计算Cell的高度常常困扰着我。自从使用了这个组件之后，一切都变得没那么复杂。所以深入学习下这个框架的组件的实现原理。</li>
<li>框架地址：<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell" target="_blank" rel="external">https://github.com/forkingdog/UITableView-FDTemplateLayoutCell</a></li>
</ul>
<hr>
<h3 id="代码文件目录"><a href="#代码文件目录" class="headerlink" title="代码文件目录"></a>代码文件目录</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- <span class="built_in">UITableView</span>+FDIndexPathHeightCache.h</div><div class="line">- <span class="built_in">UITableView</span>+FDIndexPathHeightCache.m</div><div class="line">- <span class="built_in">UITableView</span>+FDKeyedHeightCache.h</div><div class="line">- <span class="built_in">UITableView</span>+FDKeyedHeightCache.m</div><div class="line">- <span class="built_in">UITableView</span>+FDTemplateLayoutCell.h</div><div class="line">- <span class="built_in">UITableView</span>+FDTemplateLayoutCell.m</div><div class="line">- <span class="built_in">UITableView</span>+FDTemplateLayoutCellDebug.h</div><div class="line">- <span class="built_in">UITableView</span>+FDTemplateLayoutCellDebug.m</div></pre></td></tr></table></figure>
<hr>
<p>首先，介绍一下这几个类的基本功能，再层层推进，逐一分析。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- <span class="built_in">UITableView</span>+FDIndexPathHeightCache，主要负责cell通过<span class="built_in">NSIndexPath</span>进行缓存高度的功能</div><div class="line">- <span class="built_in">UITableView</span>+FDKeyedHeightCache，主要负责cell通过key值进行缓存高度的功能</div><div class="line">- <span class="built_in">UITableView</span>+FDTemplateLayoutCell，提供接口方法方便用户定义cell的数据源，以及帮助我们计算cell的高度</div><div class="line">- <span class="built_in">UITableView</span>+FDTemplateLayoutCellDebug，提供一些Debug打印信息</div></pre></td></tr></table></figure>
<hr>
<p>关于这个框架，坦白说，从代码中看，作者无疑秀了一波runtime底层的功底，让我这种小白起初一脸懵逼。自然我得换种思路来解读这个框架，那就是从字数最少的类入手吧。</p>
<h3 id="UITableView-FDTemplateLayoutCellDebug"><a href="#UITableView-FDTemplateLayoutCellDebug" class="headerlink" title="UITableView+FDTemplateLayoutCellDebug"></a>UITableView+FDTemplateLayoutCellDebug</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableView</span> (<span class="title">FDTemplateLayoutCellDebug</span>)</span></div><div class="line"></div><div class="line"><span class="comment">//设置Debug模式是否打开</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> fd_debugLogEnabled;</div><div class="line"></div><div class="line"><span class="comment">//通过该方法，传递NSLog打印对应的Debug信息</span></div><div class="line">- (<span class="keyword">void</span>)fd_debugLog:(<span class="built_in">NSString</span> *)message;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UITableView</span> (<span class="title">FDTemplateLayoutCellDebug</span>)</span></div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)fd_debugLogEnabled &#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) boolValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setFd_debugLogEnabled:(<span class="built_in">BOOL</span>)debugLogEnabled &#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(fd_debugLogEnabled), @(debugLogEnabled), OBJC_ASSOCIATION_RETAIN);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)fd_debugLog:(<span class="built_in">NSString</span> *)message &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.fd_debugLogEnabled) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"** FDTemplateLayoutCell ** %@"</span>, message);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<ul>
<li>在分类中，如果要声明属性，可以通过使用关联度对象( AssociatedObject ), 通过objc_setAssociatedObject() 添加属性，objc_getAssociatedObject() 获取属性。实际上，相当于在运行时系统中动态地在内存中开辟一块空间，存储debugLogEnabled这个BOOL变量，类似懒加载的方式，通过runtime实现setter &amp; getter方法。</li>
<li>关于runtime的知识点，推荐这篇博客:<a href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/" target="_blank" rel="external">http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/</a></li>
</ul>
<hr>
<h3 id="UITableView-FDKeyedHeightCache"><a href="#UITableView-FDKeyedHeightCache" class="headerlink" title="UITableView+FDKeyedHeightCache"></a>UITableView+FDKeyedHeightCache</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FDKeyedHeightCache</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">//判断缓存中是否存在key为值的缓存高度</span></div><div class="line">- (<span class="built_in">BOOL</span>)existsHeightForKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key;</div><div class="line"></div><div class="line"><span class="comment">//对指定key的cell设置高度为height</span></div><div class="line">- (<span class="keyword">void</span>)cacheHeight:(<span class="built_in">CGFloat</span>)height byKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key;</div><div class="line"></div><div class="line"><span class="comment">//从缓存中获取对应key的cell的高度height值</span></div><div class="line">- (<span class="built_in">CGFloat</span>)heightForKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key;</div><div class="line"></div><div class="line"><span class="comment">//从缓存中删除指定key的cell的值</span></div><div class="line">- (<span class="keyword">void</span>)invalidateHeightForKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key;</div><div class="line"></div><div class="line"><span class="comment">//移除缓存中所有的cell的高度缓存值</span></div><div class="line">- (<span class="keyword">void</span>)invalidateAllHeightCache;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableView</span> (<span class="title">FDKeyedHeightCache</span>)</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) FDKeyedHeightCache *fd_keyedHeightCache;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<ul>
<li>先来看看FDKeyedHeightCache类中声明的属性</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span>&lt;<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;, <span class="built_in">NSNumber</span> *&gt; *mutableHeightsByKeyForPortrait;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span>&lt;<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;, <span class="built_in">NSNumber</span> *&gt; *mutableHeightsByKeyForLandscape;</div></pre></td></tr></table></figure>
<p>不难看出，这是两个指定泛型的可变字典。</p>
<ul>
<li>mutableHeightsByKeyForPortrait : 用于缓存设备竖直放置时，对应key的cell的高度值。</li>
<li>mutableHeightsByKeyForLandscape : 用于缓存设备横向放置时，对应key的cell的高度值。</li>
</ul>
<hr>
<ul>
<li>FDKeyedHeightCache中的接口方法</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)existsHeightForKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key &#123;</div><div class="line">    <span class="built_in">NSNumber</span> *number = <span class="keyword">self</span>.mutableHeightsByKeyForCurrentOrientation[key];</div><div class="line">    <span class="keyword">return</span> number &amp;&amp; ![number isEqualToNumber:@<span class="number">-1</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)cacheHeight:(<span class="built_in">CGFloat</span>)height byKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key &#123;</div><div class="line">    <span class="keyword">self</span>.mutableHeightsByKeyForCurrentOrientation[key] = @(height);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">CGFloat</span>)heightForKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key &#123;</div><div class="line"><span class="meta">#if CGFLOAT_IS_DOUBLE</span></div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.mutableHeightsByKeyForCurrentOrientation[key] doubleValue];</div><div class="line"><span class="meta">#else</span></div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.mutableHeightsByKeyForCurrentOrientation[key] floatValue];</div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)invalidateHeightForKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key &#123;</div><div class="line">    [<span class="keyword">self</span>.mutableHeightsByKeyForPortrait removeObjectForKey:key];</div><div class="line">    [<span class="keyword">self</span>.mutableHeightsByKeyForLandscape removeObjectForKey:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)invalidateAllHeightCache &#123;</div><div class="line">    [<span class="keyword">self</span>.mutableHeightsByKeyForPortrait removeAllObjects];</div><div class="line">    [<span class="keyword">self</span>.mutableHeightsByKeyForLandscape removeAllObjects];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>这些方法并不晦涩，看到这里，大家不禁会问，self.mutableHeightsByKeyForCurrentOrientation从何而来，这也是我觉得这个类中，细节处理比较好的地方，由于此处考虑到缓存的高度区别了设备方向，所以框架作者，通过一个getter方法来获取对应的存放高度的字典。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSMutableDictionary</span>&lt;<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;, <span class="built_in">NSNumber</span> *&gt; *)mutableHeightsByKeyForCurrentOrientation &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIDeviceOrientationIsPortrait</span>([<span class="built_in">UIDevice</span> currentDevice].orientation) ? <span class="keyword">self</span>.mutableHeightsByKeyForPortrait: <span class="keyword">self</span>.mutableHeightsByKeyForLandscape;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>根据UIDeviceOrientationIsPortrait()函数，传入当前设备的放置方向（[UIDevice currentDevice].orientation</p>
<p>）进行判断。从而便可以通过属性简洁判断需要从那个字典中取值了。</p>
</li>
</ul>
<hr>
<h3 id="UITableView-FDIndexPathHeightCache"><a href="#UITableView-FDIndexPathHeightCache" class="headerlink" title="UITableView+FDIndexPathHeightCache"></a>UITableView+FDIndexPathHeightCache</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FDIndexPathHeightCache</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">// 如果您使用索引路径获取高度缓存，则自动启用</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> automaticallyInvalidateEnabled;</div><div class="line"></div><div class="line"><span class="comment">// Height cache</span></div><div class="line">- (<span class="built_in">BOOL</span>)existsHeightAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</div><div class="line">- (<span class="keyword">void</span>)cacheHeight:(<span class="built_in">CGFloat</span>)height byIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</div><div class="line">- (<span class="built_in">CGFloat</span>)heightForIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</div><div class="line">- (<span class="keyword">void</span>)invalidateHeightAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</div><div class="line">- (<span class="keyword">void</span>)invalidateAllHeightCache;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableView</span> (<span class="title">FDIndexPathHeightCache</span>)</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) FDIndexPathHeightCache *fd_indexPathHeightCache;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableView</span> (<span class="title">FDIndexPathHeightCacheInvalidation</span>)</span></div><div class="line"><span class="comment">/// 当你不想通过删除缓存中的高度来刷新数据源重新计算时，可以调用这个方法。</span></div><div class="line"><span class="comment">/// 该方法中用过runtime重写了tableView中修改cell的一些方法，例如插入cell，删除cell，移动cell，以及reloadData方法。</span></div><div class="line">- (<span class="keyword">void</span>)fd_reloadDataWithoutInvalidateIndexPathHeightCache;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<ul>
<li>首先看看FDIndexPathHeightCache中设置的属性</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSNumber</span> *&gt; *&gt; FDIndexPathHeightsBySection;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FDIndexPathHeightCache</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) FDIndexPathHeightsBySection *heightsBySectionForPortrait;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) FDIndexPathHeightsBySection *heightsBySectionForLandscape;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>通过前面key的高度缓存分析，不难猜出这几个属性是干什么的。</p>
<ul>
<li>由于通过NSIndexPath获取高度缓存，NSIndexPath对应section, 以及indexPath。FDIndexPathHeightsBySection这个数组，通过数组嵌套字典的数据结构来存储，不同的section组中对应的cell的高度缓存。</li>
</ul>
<hr>
<ul>
<li><p>FDIndexPathHeightCache中的方法</p>
<p>由于头文件声明的几个接口方法，与FDKeyedHeightCache中的思路类似，就不再费口舌了，大家翻看源码便一目了然。</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)enumerateAllOrientationsUsingBlock:(<span class="keyword">void</span> (^)(FDIndexPathHeightsBySection *heightsBySection))block &#123;</div><div class="line">    block(<span class="keyword">self</span>.heightsBySectionForPortrait);</div><div class="line">    block(<span class="keyword">self</span>.heightsBySectionForLandscape);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)invalidateHeightAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</div><div class="line">    [<span class="keyword">self</span> buildCachesAtIndexPathsIfNeeded:@[indexPath]];</div><div class="line">    [<span class="keyword">self</span> enumerateAllOrientationsUsingBlock:^(FDIndexPathHeightsBySection *heightsBySection &#123;</div><div class="line">        heightsBySection[indexPath.section][indexPath.row] = @<span class="number">-1</span>;</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)invalidateAllHeightCache &#123;</div><div class="line">    [<span class="keyword">self</span> enumerateAllOrientationsUsingBlock:^(FDIndexPathHeightsBySection *heightsBySection) &#123;</div><div class="line">        [heightsBySection removeAllObjects];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)buildCachesAtIndexPathsIfNeeded:(<span class="built_in">NSArray</span> *)indexPaths &#123;</div><div class="line">    <span class="comment">// Build every section array or row array which is smaller than given index path.</span></div><div class="line">    [indexPaths enumerateObjectsUsingBlock:^(<span class="built_in">NSIndexPath</span> *indexPath, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">        [<span class="keyword">self</span> buildSectionsIfNeeded:indexPath.section];</div><div class="line">        [<span class="keyword">self</span> buildRowsIfNeeded:indexPath.row inExistSection:indexPath.section];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)buildSectionsIfNeeded:(<span class="built_in">NSInteger</span>)targetSection &#123;</div><div class="line">    [<span class="keyword">self</span> enumerateAllOrientationsUsingBlock:^(FDIndexPathHeightsBySection *heightsBySection) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> section = <span class="number">0</span>; section &lt;= targetSection; ++section) &#123;</div><div class="line">            <span class="keyword">if</span> (section &gt;= heightsBySection.count) &#123;</div><div class="line">                heightsBySection[section] = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)buildRowsIfNeeded:(<span class="built_in">NSInteger</span>)targetRow inExistSection:(<span class="built_in">NSInteger</span>)section &#123;</div><div class="line">    [<span class="keyword">self</span> enumerateAllOrientationsUsingBlock:^(FDIndexPathHeightsBySection *heightsBySection) &#123;</div><div class="line">        <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSNumber</span> *&gt; *heightsByRow = heightsBySection[section];</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> row = <span class="number">0</span>; row &lt;= targetRow; ++row) &#123;</div><div class="line">            <span class="keyword">if</span> (row &gt;= heightsByRow.count) &#123;</div><div class="line">                heightsByRow[row] = @<span class="number">-1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>这几个封装的方法，主要一点就是通过block来回调，判断删除NSIndexPath对应的cell高度缓存。</li>
</ul>
<hr>
<ul>
<li>在这个类中，最核心的莫过于UITableView (FDIndexPathHeightCacheInvalidation) 这个分类的实现细节，废话少说，继续看代码。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//我们只是转发主调用，在崩溃报告中，最顶层的方法在堆栈可能存在FD，</span></div><div class="line"><span class="comment">//但它真的不是我们的错误，你应该检查你的表视图的数据源和</span></div><div class="line"><span class="comment">//重新加载时显示单元格不匹配。</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __FD_TEMPLATE_LAYOUT_CELL_PRIMARY_CALL_IF_CRASH_NOT_OUR_BUG__(<span class="keyword">void</span> (^callout)(<span class="keyword">void</span>)) &#123;</div><div class="line">    callout();</div><div class="line">&#125;</div><div class="line"><span class="meta">#define FDPrimaryCall(...) do &#123;__FD_TEMPLATE_LAYOUT_CELL_PRIMARY_CALL_IF_CRASH_NOT_OUR_BUG__(^&#123;__VA_ARGS__&#125;);&#125; while(0)</span></div></pre></td></tr></table></figure>
<ul>
<li>调用的接口方法</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)fd_reloadDataWithoutInvalidateIndexPathHeightCache &#123;</div><div class="line">    FDPrimaryCall([<span class="keyword">self</span> fd_reloadData];);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>这个方法，主要调用的是［self fd_reloadData］，看到这里的时候，我们的第一反应应该是此处通过runtime 交换了系统方法的实现。这是一种动态的拦截技巧，也算是基础的runtime知识了，懵逼的小伙伴可以认真阅读下前面提到的关于runtime的大牛博文。</li>
</ul>
<hr>
<ul>
<li>既然如此，先来看看作者重写了哪些系统的方法吧。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">void</span>)load &#123;</div><div class="line">    <span class="comment">// All methods that trigger height cache's invalidation</span></div><div class="line">    SEL selectors[] = &#123;</div><div class="line">        <span class="keyword">@selector</span>(reloadData),</div><div class="line">        <span class="keyword">@selector</span>(insertSections:withRowAnimation:),</div><div class="line">        <span class="keyword">@selector</span>(deleteSections:withRowAnimation:),</div><div class="line">        <span class="keyword">@selector</span>(reloadSections:withRowAnimation:),</div><div class="line">        <span class="keyword">@selector</span>(moveSection:toSection:),</div><div class="line">        <span class="keyword">@selector</span>(insertRowsAtIndexPaths:withRowAnimation:),</div><div class="line">        <span class="keyword">@selector</span>(deleteRowsAtIndexPaths:withRowAnimation:),</div><div class="line">        <span class="keyword">@selector</span>(reloadRowsAtIndexPaths:withRowAnimation:),</div><div class="line">        <span class="keyword">@selector</span>(moveRowAtIndexPath:toIndexPath:)</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> index = <span class="number">0</span>; index &lt; <span class="keyword">sizeof</span>(selectors) / <span class="keyword">sizeof</span>(SEL); ++index) &#123;</div><div class="line">        SEL originalSelector = selectors[index];</div><div class="line">        SEL swizzledSelector = <span class="built_in">NSSelectorFromString</span>([<span class="string">@"fd_"</span> stringByAppendingString:<span class="built_in">NSStringFromSelector</span>(originalSelector)]);</div><div class="line">        Method originalMethod = class_getInstanceMethod(<span class="keyword">self</span>, originalSelector);</div><div class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="keyword">self</span>, swizzledSelector);</div><div class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过method_exchangeImplementations() C函数， 将重写的方法，一一交换成重写的方法。</li>
<li>在这些fd_方法中的实现细节中，需要注意的一点就是，如果对应的fd_indexPathHeightCache设置了automaticallyInvalidateEnabled属性为YES时，对应的方法对高度缓存做相应的处理，重新更新fd_indexPathHeightCache中存储的高度缓存。</li>
<li>当第一次reloadData，或者cell的行数发生变化（增减行，section) ，会先在tableview不处于滚动状态的时候异步计算那些没有被计算过的cell的高度，做预缓存，这个想法非常赞。</li>
<li>使用者需要小心，这些调用是异步的, tableview delegate有可能会在预缓存计算的时候不存在了，导致程序崩溃，所以使用者在tableview需要析构的时候，在对应的tableview controller的dealloc中讲self.tableview.delegate = nil；，确保delegate后续不会是一个野指针。</li>
</ul>
<hr>
<h3 id="UITableView-FDTemplateLayoutCell"><a href="#UITableView-FDTemplateLayoutCell" class="headerlink" title="UITableView+FDTemplateLayoutCell"></a>UITableView+FDTemplateLayoutCell</h3><p>至此，我们已经分析了几个子类的实现逻辑，唯一剩下一个分类，也是我们使用这个框架的入口 <strong>FDTemplateLayoutCell</strong>分类。全面了解这个组件近在咫尺。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableView</span> (<span class="title">FDTemplateLayoutCell</span>)</span></div><div class="line"></div><div class="line"><span class="comment">/* 为给定的重用标识符访问内部模板布局单元格。</span></div><div class="line"> * 一般来说，你不需要知道这些模板布局单元格。</div><div class="line"> * @param identifier重用必须注册的单元格的标识符。</div><div class="line">*/ </div><div class="line">- (__kindof <span class="built_in">UITableViewCell</span> *)fd_templateCellForReuseIdentifier:(<span class="built_in">NSString</span> *)identifier;</div><div class="line"></div><div class="line"><span class="comment">/* 返回由重用标识符指定并配置的类型的单元格的高度, 并通过block来配置。</span></div><div class="line"> * 单元格将被放置在固定宽度，垂直扩展的基础上，相对于其动态内容，使用自动布局。 </div><div class="line"> * 因此，这些必要的单元被设置为自适应，即其内容总是确定它的宽度给定的宽度等于tableview的宽度。</div><div class="line"> * @param identifier用于检索和维护模板的字符串标识符cell通过系统方法</div><div class="line"> * '- dequeueReusableCellWithIdentifier：'</div><div class="line"> * @param configuration用于配置和提供内容的可选块到模板单元格。 </div><div class="line"> * 配置应该是最小的滚动性能足以计算单元格的高度。</div><div class="line">*/</div><div class="line">- (<span class="built_in">CGFloat</span>)fd_heightForCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier configuration:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> cell))configuration;</div><div class="line"></div><div class="line"><span class="comment">/* 计算的高度将通过其索引路径进行高速缓存，当需要时返回高速缓存的高度，因此，可以节省大量额外的高度计算。</span></div><div class="line"> * 无需担心数据源更改时使缓存高度无效，它将在调用“-reloadData”或任何触发方法时自动完成UITableView的重新加载。</div><div class="line"> * @param indexPath此单元格的高度缓存所属的位置。</div><div class="line">*/</div><div class="line">- (<span class="built_in">CGFloat</span>)fd_heightForCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier cacheByIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath configuration:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> cell))configuration;</div><div class="line"></div><div class="line"><span class="comment">/* 此方法通过模型实体的标识符缓存高度。</span></div><div class="line"> * 如果你的模型改变，调用“-invalidateHeightForKey:(id &lt;NSCopying&gt;)key”到无效缓存并重新计算，它比“cacheByIndexPath”方便得多。</div><div class="line"> * @param key model entity的标识符，其数据配置一个单元格。</div><div class="line">*/ </div><div class="line">- (<span class="built_in">CGFloat</span>)fd_heightForCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier cacheByKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key configuration:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> cell))configuration;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableView</span> (<span class="title">FDTemplateLayoutHeaderFooterView</span>)</span></div><div class="line"></div><div class="line"><span class="comment">/* 返回在具有重用标识符的表视图中注册的Header或Footer视图的高度。</span></div><div class="line"> * 在调用“ - [UITableView registerNib / Class：forHeaderFooterViewReuseIdentifier]”之后使用它，</div><div class="line"> * 与“-fd_heightForCellWithIdentifier：configuration：”相同。</div><div class="line"> * 它将调用“-sizeThatFits：”</div><div class="line"> * UITableViewHeaderFooterView的子类不使用自动布局。</div><div class="line">*/ </div><div class="line">- (<span class="built_in">CGFloat</span>)fd_heightForHeaderFooterViewWithIdentifier:(<span class="built_in">NSString</span> *)identifier configuration:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> headerFooterView))configuration;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableViewCell</span> (<span class="title">FDTemplateLayoutCell</span>)</span></div><div class="line"><span class="comment">/* 指示这是仅用于计算的模板布局单元格。</span></div><div class="line"> * 当配置单元格时，如果有非UI的副作用，你可能需要这个。</div><div class="line"> * 类似:</div><div class="line"> *   - (void)configureCell:(FooCell *)cell atIndexPath:(NSIndexPath *)indexPath &#123;</div><div class="line"> *       cell.entity = [self entityAtIndexPath:indexPath];</div><div class="line"> *       if (!cell.fd_isTemplateLayoutCell) &#123;</div><div class="line"> *           [self notifySomething]; // non-UI side effects</div><div class="line"> *       &#125;</div><div class="line"> *   &#125;</div><div class="line">*/</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> fd_isTemplateLayoutCell;</div><div class="line"></div><div class="line"><span class="comment">/* 启用以强制此模板布局单元格使用“框架布局”而不是“自动布局”，</span></div><div class="line"> * 并且通过调用“-sizeThatFits：”来询问单元格的高度，所以你必须重写这个方法。</div><div class="line"> * 仅当要手动控制此模板布局单元格的高度时才使用此属性</div><div class="line"> * 计算模式，默认为NO。</div><div class="line">*/</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> fd_enforceFrameLayout;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<hr>
<ul>
<li>先来看看我们平时开发中最频繁调用的两个方法</li>
<li>(CGFloat)fd_heightForCellWithIdentifier:(NSString <em>)identifier cacheByIndexPath:(NSIndexPath </em>)indexPath configuration:(void (^)(id cell))configuration;</li>
<li>(CGFloat)fd_heightForCellWithIdentifier:(NSString *)identifier cacheByKey:(id<nscopying>)key configuration:(void (^)(id cell))configuration;</nscopying></li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CGFloat</span>)fd_heightForCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier cacheByIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath configuration:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> cell))configuration &#123;</div><div class="line">    <span class="keyword">if</span> (!identifier || !indexPath) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Hit cache</span></div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.fd_indexPathHeightCache existsHeightAtIndexPath:indexPath]) &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>.fd_indexPathHeightCache heightForIndexPath:indexPath];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">CGFloat</span> height = [<span class="keyword">self</span> fd_heightForCellWithIdentifier:identifier configuration:configuration];</div><div class="line">    [<span class="keyword">self</span>.fd_indexPathHeightCache cacheHeight:height byIndexPath:indexPath];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> height;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">CGFloat</span>)fd_heightForCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier cacheByKey:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key configuration:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> cell))configuration &#123;</div><div class="line">    <span class="keyword">if</span> (!identifier || !key) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Hit cache</span></div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.fd_keyedHeightCache existsHeightForKey:key]) &#123;</div><div class="line">        <span class="built_in">CGFloat</span> cachedHeight = [<span class="keyword">self</span>.fd_keyedHeightCache heightForKey:key];</div><div class="line">        <span class="keyword">return</span> cachedHeight;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">CGFloat</span> height = [<span class="keyword">self</span> fd_heightForCellWithIdentifier:identifier configuration:configuration];</div><div class="line">    [<span class="keyword">self</span>.fd_keyedHeightCache cacheHeight:height byKey:key];</div><div class="line">    <span class="keyword">return</span> height;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>这两个方法，分别是对cell通过NSIndexPath 或者 key值 进行高度缓存，读取高度的时候，先从缓存cache中读取，如果缓存中没有，在通过[self fd_heightForCellWithIdentifier:identifier configuration:configuration]方法进行计算高度并加入缓存中。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CGFloat</span>)fd_heightForCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier configuration:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> cell))configuration &#123;</div><div class="line">    <span class="keyword">if</span> (!identifier) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">UITableViewCell</span> *templateLayoutCell = [<span class="keyword">self</span> fd_templateCellForReuseIdentifier:identifier];</div><div class="line">    </div><div class="line">    <span class="comment">//手动调用以确保与实际单元格的一致行为。 （显示在屏幕上）</span></div><div class="line">    [templateLayoutCell prepareForReuse];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (configuration) &#123;</div><div class="line">        configuration(templateLayoutCell);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> fd_systemFittingHeightForConfiguratedCell:templateLayoutCell];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过blocks进行配置并计算cell的高度，主要通过[self fd_templateCellForReuseIdentifier:identifier]方法创建一个UITableViewCell的实例templateLayoutCell，最后再把templateLayoutCell放入[self fd_systemFittingHeightForConfiguratedCell:templateLayoutCell]中进行计算返回高度。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">- (__kindof <span class="built_in">UITableViewCell</span> *)fd_templateCellForReuseIdentifier:(<span class="built_in">NSString</span> *)identifier &#123;</div><div class="line">    <span class="built_in">NSAssert</span>(identifier.length &gt; <span class="number">0</span>, <span class="string">@"Expect a valid identifier - %@"</span>, identifier);</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="built_in">UITableViewCell</span> *&gt; *templateCellsByIdentifiers = objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</div><div class="line">    <span class="keyword">if</span> (!templateCellsByIdentifiers) &#123;</div><div class="line">        templateCellsByIdentifiers = @&#123;&#125;.mutableCopy;</div><div class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, _cmd, templateCellsByIdentifiers, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">UITableViewCell</span> *templateCell = templateCellsByIdentifiers[identifier];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!templateCell) &#123;</div><div class="line">        templateCell = [<span class="keyword">self</span> dequeueReusableCellWithIdentifier:identifier];</div><div class="line">        <span class="built_in">NSAssert</span>(templateCell != <span class="literal">nil</span>, <span class="string">@"Cell must be registered to table view for identifier - %@"</span>, identifier);</div><div class="line">        templateCell.fd_isTemplateLayoutCell = <span class="literal">YES</span>;</div><div class="line">        templateCell.contentView.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</div><div class="line">        templateCellsByIdentifiers[identifier] = templateCell;</div><div class="line">        [<span class="keyword">self</span> fd_debugLog:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"layout cell created - %@"</span>, identifier]];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> templateCell;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>将所有创建的templateCell放置在一个字典templateCellsByIdentifiers中，并通过runtime将其加入内存中作为属性，实际上，templateCell 也是通过identifier在复用队列中获取复用的。所以，cell在使用前，应先注册为cell的复用对象。</li>
<li>最后调用的[self fd_systemFittingHeightForConfiguratedCell:templateLayoutCell]进行高度计算。当然也是最关键的一个操作，既然这是一个高度计算的框架，那么计算的步骤当然是重中之重。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CGFloat</span>)fd_systemFittingHeightForConfiguratedCell:(<span class="built_in">UITableViewCell</span> *)cell &#123;</div><div class="line">    <span class="built_in">CGFloat</span> contentViewWidth = <span class="built_in">CGRectGetWidth</span>(<span class="keyword">self</span>.frame);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (cell.accessoryView) &#123;</div><div class="line">        <span class="comment">//如果有定制accessoryView，则去除这个宽度</span></div><div class="line">        contentViewWidth -= <span class="number">16</span> + <span class="built_in">CGRectGetWidth</span>(cell.accessoryView.frame);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//如果有系统accessoryView展示，则去除对应的宽度。</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">CGFloat</span> systemAccessoryWidths[] = &#123;</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryNone</span>] = <span class="number">0</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryDisclosureIndicator</span>] = <span class="number">34</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryDetailDisclosureButton</span>] = <span class="number">68</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryCheckmark</span>] = <span class="number">40</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryDetailButton</span>] = <span class="number">48</span></div><div class="line">        &#125;;</div><div class="line">        contentViewWidth -= systemAccessoryWidths[cell.accessoryType];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">CGFloat</span> fittingHeight = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!cell.fd_enforceFrameLayout &amp;&amp; contentViewWidth &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//如果是自动布局，则将contentView的宽度约束添加进去。</span></div><div class="line">        <span class="comment">//这样做的目的是让UILabel之类的内容可能多行的控件适应这个宽度折行（当然前提是我们已经设置好了这些控件的布局约束）。然后调用systemLayoutSizeFittingSize来计算高度。</span></div><div class="line">        <span class="comment">//最后移除刚才临时添加的contentView宽度约束。</span></div><div class="line">        <span class="built_in">NSLayoutConstraint</span> *widthFenceConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:cell.contentView attribute:<span class="built_in">NSLayoutAttributeWidth</span> relatedBy:<span class="built_in">NSLayoutRelationEqual</span> toItem:<span class="literal">nil</span> attribute:<span class="built_in">NSLayoutAttributeNotAnAttribute</span> multiplier:<span class="number">1.0</span> constant:contentViewWidth];</div><div class="line">        [cell.contentView addConstraint:widthFenceConstraint];</div><div class="line">        </div><div class="line">        fittingHeight = [cell.contentView systemLayoutSizeFittingSize:<span class="built_in">UILayoutFittingCompressedSize</span>].height;</div><div class="line">        [cell.contentView removeConstraint:widthFenceConstraint];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (fittingHeight == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 尝试调用 '- sizeThatFits:'进行高度计算.</span></div><div class="line">        <span class="comment">// 注意：配件高度不应包括分隔线视图高度。</span></div><div class="line">        fittingHeight = [cell sizeThatFits:<span class="built_in">CGSizeMake</span>(contentViewWidth, <span class="number">0</span>)].height;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 进行完前面的逻辑后高度如果仍然为0，则使用默认行高44</span></div><div class="line">    <span class="keyword">if</span> (fittingHeight == <span class="number">0</span>) &#123;</div><div class="line">        fittingHeight = <span class="number">44</span>;        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 添加一像素作为tableView分割线高度。</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.separatorStyle != <span class="built_in">UITableViewCellSeparatorStyleNone</span>) &#123;</div><div class="line">        fittingHeight += <span class="number">1.0</span> / [<span class="built_in">UIScreen</span> mainScreen].scale;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> fittingHeight;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，就大致将这个框架分析的差不多了，源码中，对类的实例化均为采用runtime添加AssociatedObject的方式。就不做解释了。</p>
<hr>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><ul>
<li><p>赏花不忘种花人，把作者关于这个框架优秀的性能分析复习下。</p>
</li>
<li><p>地址：<a href="http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/" target="_blank" rel="external">http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/</a></p>
<p>​</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="/2016/08/09/NSOperation：初识/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Liuxi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Shawenlx">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Shawenlx" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/09/NSOperation：初识/" itemprop="url">
                  NSOperation：初识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-09T19:02:00+08:00">
                2016-08-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/08/09/NSOperation：初识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/09/NSOperation：初识/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="NSOperation的简介"><a href="#NSOperation的简介" class="headerlink" title="NSOperation的简介"></a>NSOperation的简介</h3><p>NSOperation的抽象程度高于NSThread，它是苹果对线程的一个面向对象封装。NSOperation表示一个独立的计算单元，作为一个抽象类，你需要实例化他的子类 : NSInvocationOperation / NSBlockOperation 来进行具体操作。实例化之后，调用start方法或者加入到一个NSOperationQueue 操作队列中，就可以开始执行。</p>
<hr>
<h3 id="NSOperation的使用"><a href="#NSOperation的使用" class="headerlink" title="NSOperation的使用"></a>NSOperation的使用</h3><ul>
<li>启动NSInvocationOperation</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如果直接调用operation的start方法，是在主线程上运行，不会开启新的线程</span></div><div class="line"><span class="built_in">NSInvocationOperation</span> *operation = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(threadLoadImage:) object:imageView];</div><div class="line">[operation start];</div></pre></td></tr></table></figure>
<ul>
<li>使用NSOperationQueue管理NSOperation并开启一个异步线程</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义操作队列属性</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSOperationQueue</span> *queue;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 实例化操作队列</span></div><div class="line"><span class="keyword">self</span>.queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始化一个NSInvocationOperation</span></div><div class="line"><span class="built_in">NSInvocationOperation</span> *operation = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(threadLoadImage:) object:imageView];</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 将NSInvocationOperation添加到队列，一添加到队列，就会开启新线程执行任务，不可以同时使用start</span></div><div class="line">[<span class="keyword">self</span>.queue addOperation:operation];</div></pre></td></tr></table></figure>
<ul>
<li>使用NSOperationQueue管理并NSBlockOperation开启一个线程<ul>
<li>更偏向于使用NSBlockOperation，原因在于通过使用代码块会更方便一些，本质上和NSInvocationOperation没有区别。</li>
</ul>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始化一个NSBlockOperation</span></div><div class="line"><span class="built_in">NSBlockOperation</span> *operation = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123; <span class="comment">// 异步操作 [self operationLoadImage:imageView];&#125;];</span></div><div class="line"><span class="comment">// 添加操作到队列中</span></div><div class="line">[<span class="keyword">self</span>.queue addOperation:operation];</div></pre></td></tr></table></figure>
<ul>
<li>在主线程中执行操作</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//可通过该＋方法 获取系统主线程，通常我们刷新UI界面进行绘制的时候，必须在主线程下完成。</span></div><div class="line">+ (<span class="built_in">NSOperationQueue</span> *)mainQueue <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_6, <span class="number">4</span>_0);</div><div class="line"></div><div class="line"><span class="comment">//该＋号方法可以获取当前使用线程</span></div><div class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSOperationQueue</span> *)currentQueue <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_6, <span class="number">4</span>_0);</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在主线程队列上更新UI</span></div><div class="line">[[<span class="built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;</div><div class="line">   [imageView setImage:image];</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<ul>
<li>通过 addDependency：添加线程之间的依赖关系<ul>
<li>Tip: 直接在队列中添加操作会并发执行，执行顺序是系统调用决定的，在特定的时候我们需要控制操作的执行顺序，就会使用到addDependency操作。addDependency: 是NSOperation的成员方法，调用该方法的NSOperation对象将在参数执行完成之后执行。<strong>需要先添加依赖关系，再将操作添加到队列中。</strong></li>
</ul>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始化三个块操作</span></div><div class="line">  <span class="built_in">NSBlockOperation</span> *op1 =[<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"下载 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">  &#125;];</div><div class="line">  </div><div class="line">  <span class="built_in">NSBlockOperation</span> *op2 =[<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"美化 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">  &#125;];</div><div class="line">  </div><div class="line">  <span class="built_in">NSBlockOperation</span> *op3 =[<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</div><div class="line">      <span class="built_in">NSLog</span>(<span class="string">@"更新 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">  &#125;];</div><div class="line">  </div><div class="line">  <span class="comment">// 通过添加依赖可以控制线程执行顺序，依赖关系可以多重依赖</span></div><div class="line">  <span class="comment">// 注意：不要建立循环依赖，会造成死锁</span></div><div class="line">  [op2 addDependency:op1];</div><div class="line">  [op3 addDependency:op2];</div><div class="line">  </div><div class="line">  <span class="comment">// 直接加到队列里面会并发执行，谁先先后是系统调用决定</span></div><div class="line">  [<span class="keyword">self</span>.operationQueue addOperation:op3];</div><div class="line">  [<span class="keyword">self</span>.operationQueue addOperation:op1];</div><div class="line">  [<span class="keyword">self</span>.operationQueue addOperation:op2];</div></pre></td></tr></table></figure>
<ul>
<li>控制线程并发数</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 并发的线程越多越耗资源，队列可以设置同时并发线程的数量，来进行控制</span></div><div class="line"><span class="keyword">self</span>.queue.maxConcurrentOperationCount = <span class="number">2</span>;</div></pre></td></tr></table></figure>
<ul>
<li>取消线程操作<ul>
<li>NSOperation里有一系列的属性用来标明自身状态的，isReady → isExecuting →isFinish。线程start后并不是立即执行，而是进入一个就绪的状态（isReady），由系统调度执行。</li>
</ul>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//有时可能需要进行取消操作，可以调用– (void)cancel; 来停止一些还未执行的不必要的线程。</span></div><div class="line">[operation cancel];</div></pre></td></tr></table></figure>
<ul>
<li>为NSOperation添加完成代码块</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">operation.completionBlock = ^&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"completion!"</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>NSOperation的优先级</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//同NSThread一样，NSOperation可以通过threadPriority属性来指定优先级。</span></div><div class="line"><span class="comment">//但是在IOS8，线程这个概念已经被苹果框架系统性的忽略了，threadPriority已由NSQualityOfService属性替代.</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">NSQualityOfService</span>) &#123;</div><div class="line"></div><div class="line">   <span class="comment">/* 和图形处理相关的任务，比如滚动和动画 */</span> </div><div class="line">   <span class="built_in">NSQualityOfServiceUserInteractive</span> = <span class="number">0x21</span>, </div><div class="line">   <span class="comment">/* 用户请求的任务，但是不需要精确到毫秒级。例如如果用户请求打开电子邮件App来查看邮件 */</span> </div><div class="line">   <span class="built_in">NSQualityOfServiceUserInitiated</span> = <span class="number">0x19</span>, </div><div class="line">   <span class="comment">/* 周期性的用户请求任务。比如，电子邮件App可能被设置成每5分钟自动检测新邮件。但是在系统资源极度匮乏的时候，将这个周期性的任务推迟几分钟也没有大碍*/</span> </div><div class="line">   <span class="built_in">NSQualityOfServiceUtility</span> = <span class="number">0x11</span>,</div><div class="line">   <span class="comment">/* 后台任务，对这些任务用户可能并不会察觉，比如电子邮件App对邮件进行索引以方便搜索 */</span> </div><div class="line">   <span class="built_in">NSQualityOfServiceBackground</span> = <span class="number">0x09</span>,</div><div class="line"></div><div class="line">   <span class="comment">/* 默认的优先级 */</span> </div><div class="line">   <span class="built_in">NSQualityOfServiceDefault</span> = <span class="number">-1</span></div><div class="line"></div><div class="line">&#125; <span class="built_in">NS_ENUM_AVAILABLE</span>(<span class="number">10</span>_10, <span class="number">8</span>_0);</div></pre></td></tr></table></figure>
<hr>
<h3 id="NSOperation优势"><a href="#NSOperation优势" class="headerlink" title="NSOperation优势"></a>NSOperation优势</h3><ul>
<li><strong>NSOperation方便控制线程执行顺序</strong></li>
<li><strong>使用NSBlockOperation可以使用块代码，不必单写线程方法，便于传递多个参数</strong></li>
<li><strong>可以控制线程并发数，有效地对线程进行控制</strong></li>
<li><strong>可以添加线程完成代码块，执行需要的操作</strong></li>
</ul>
<hr>
<h3 id="对比GCD-和-NSOperation"><a href="#对比GCD-和-NSOperation" class="headerlink" title="对比GCD 和 NSOperation"></a>对比GCD 和 NSOperation</h3><p>虽然GCD已经成为流行， 但是在某些框架中，例如AFNetworking还是使用的NSOperation来完成线程相关的操作，除了使用框架的NSInvocationOperation / NSBlockOperation 来处理线程操作，你也可以通过自定义集成来完成你需要的操作。</p>
<hr>
<h3 id="关于NSOperation博客的传送门"><a href="#关于NSOperation博客的传送门" class="headerlink" title="关于NSOperation博客的传送门"></a>关于NSOperation博客的传送门</h3><p><a href="http://www.cnblogs.com/kenshincui/p/3983982.html#NSOperation" target="_blank" rel="external">http://www.cnblogs.com/kenshincui/p/3983982.html#NSOperation</a><br><a href="http://nshipster.cn/ios8/" target="_blank" rel="external">http://nshipster.cn/ios8/</a><br><a href="http://nshipster.cn/nsoperation/" target="_blank" rel="external">http://nshipster.cn/nsoperation/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="/2016/06/09/关于链表的一些逻辑思维/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Liuxi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Shawenlx">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Shawenlx" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/09/关于链表的一些逻辑思维/" itemprop="url">
                  关于链表的一些逻辑思维
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-09T16:07:00+08:00">
                2016-06-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/algorithm/" itemprop="url" rel="index">
                    <span itemprop="name">algorithm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/06/09/关于链表的一些逻辑思维/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/09/关于链表的一些逻辑思维/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="写这个东西的原因"><a href="#写这个东西的原因" class="headerlink" title="写这个东西的原因"></a>写这个东西的原因</h3><ul>
<li>大学也即将毕业了，很多算法和数据结构的东西可能在iOS开发中并不能用得上，曾经有颗去BAT的心，错过了校招，希望厚积薄发，两三年后或许还有机会。记录下，那些大学里为之痴迷的东西。</li>
</ul>
<hr>
<h3 id="什么是链表？"><a href="#什么是链表？" class="headerlink" title="什么是链表？"></a>什么是链表？</h3><ul>
<li>对于计算机而言，大多数数据和信号的存储方式是离散的。那么今天要介绍的链表，就是一种离散结构的数据结构。与之对应的数组，是一种连续的数据结构。</li>
<li>先来看一张相对形象的图。<br><img src="http://upload-images.jianshu.io/upload_images/2158576-9704f0de5a625994.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="list.jpg"></li>
</ul>
<hr>
<h3 id="定义链表的节点"><a href="#定义链表的节点" class="headerlink" title="定义链表的节点"></a>定义链表的节点</h3><ul>
<li>由于链表是由多个链表节点，连接而成。先看看如何定义一个节点吧，其实就是个结构体。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> Node &#123;</div><div class="line">     <span class="keyword">int</span> val;                  <span class="comment">//数据域</span></div><div class="line">     <span class="keyword">struct</span> Node *next;        <span class="comment">//指针域</span></div><div class="line">&#125;pNode;</div></pre></td></tr></table></figure>
<ul>
<li>一个节点中包含数据域和指针域，数据域用于存储节点的数据信息，而指针next则指向下一个节点的地址。从内存的角度来看，它便是离散的，因为指向的下一块内存不是连续的。</li>
</ul>
<hr>
<h3 id="如何创建单链表"><a href="#如何创建单链表" class="headerlink" title="如何创建单链表"></a>如何创建单链表</h3><ul>
<li>一条单链表中，必不可少的是头节点，相当于一个标记。个人习惯在头节点保存链表节点的个数</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//creat a list</span></div><div class="line"><span class="function"><span class="keyword">inline</span> Node *<span class="title">creat</span><span class="params">()</span> </span>&#123;</div><div class="line">     Node *head = (Node *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Node *));</div><div class="line">     head-&gt;next = <span class="literal">NULL</span>; <span class="comment">//防止野指针</span></div><div class="line">     <span class="keyword">return</span> head;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>关于malloc（）,我们可以通过这个函数对头节点分配堆上的内存空间用于存储节点信息。而sizeof关键字就是计算需要分配多少的空间了。这个地方存在一个<strong>字节对齐</strong>的问题。感兴趣的同学可以深入理解。</li>
</ul>
<hr>
<h3 id="链表的插入"><a href="#链表的插入" class="headerlink" title="链表的插入"></a>链表的插入</h3><ul>
<li>头插法，效率高，也是C++ STL中使用的一种方式。</li>
<li>尾插法，效率低，只是介绍下，毕竟还是有区别的。</li>
</ul>
<hr>
<h5 id="头插法"><a href="#头插法" class="headerlink" title="头插法"></a>头插法</h5><ul>
<li>我们可以猜测，既然是头部插入，那我们插入的元素顺序就是逆序的。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//头插法，时间复杂度O(1)</span></div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">push_front</span><span class="params">(Node *head, <span class="keyword">const</span> <span class="keyword">int</span> _val)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!head) <span class="keyword">return</span> ;  <span class="comment">//判断链表是否存在，通过头指针是否为空</span></div><div class="line">    Node *nNode = (Node *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Node *));</div><div class="line">    nNode-&gt;val = _val;</div><div class="line">    Node *pNode = head-&gt;next;</div><div class="line">    nNode-&gt;next = pNode;</div><div class="line">    head-&gt;next = nNode;</div><div class="line">    ++head-&gt;val;<span class="comment">//统计节点个数</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="尾插法"><a href="#尾插法" class="headerlink" title="尾插法"></a>尾插法</h5><ul>
<li>既然是尾部插入，那我们插入的元素顺序就是顺序的。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//尾插法，时间复杂度O(n)</span></div><div class="line"> <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">push_back</span><span class="params">(Node *head, <span class="keyword">const</span> <span class="keyword">int</span> _val)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (!head) <span class="keyword">return</span> ;</div><div class="line">     Node *nNode = (Node *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Node *));</div><div class="line">     nNode-&gt;val = _val;</div><div class="line">     Node *pNode = head;</div><div class="line">     <span class="keyword">while</span> (pNode-&gt;next) &#123;</div><div class="line">         pNode = pNode-&gt;next;</div><div class="line">     &#125;</div><div class="line">     pNode-&gt;next = nNode;</div><div class="line">     nNode-&gt;next = <span class="literal">NULL</span>;</div><div class="line">     ++head-&gt;val;<span class="comment">//统计节点个数</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>我们不难发现，之所以时间复杂度为O(n)，是因为，每次比头插法多花了一个while循环来遍历链表，直到找到链表的最后一个节点。</li>
</ul>
<hr>
<h3 id="链表删除节点"><a href="#链表删除节点" class="headerlink" title="链表删除节点"></a>链表删除节点</h3><ul>
<li>任何一种数据结构，必不可少的都包含增删查改的功能。删除也是链表操作中较为复杂的一个操作。时间复杂度即为查找删除节点的遍历的复杂度。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//删除链表中第一个值为_val的节点</span></div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node *head, <span class="keyword">const</span> <span class="keyword">int</span> _val)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!head || !head-&gt;next) <span class="keyword">return</span> ;</div><div class="line">    Node *pNode = head;</div><div class="line">    <span class="keyword">while</span> (pNode-&gt;next) &#123;</div><div class="line">        <span class="keyword">if</span> (pNode-&gt;next-&gt;val == _val) &#123;</div><div class="line">            <span class="comment">//找到要删除的元素</span></div><div class="line">            Node *dNode = pNode-&gt;next;</div><div class="line">            pNode-&gt;next = dNode-&gt;next;</div><div class="line">            <span class="keyword">if</span> (!dNode-&gt;next) &#123;</div><div class="line">                 pNode-&gt;next = <span class="literal">NULL</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">free</span>(dNode);</div><div class="line">            --head-&gt;val;<span class="comment">//更新节点统计</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        pNode = pNode-&gt;next;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="关于链表的一些巧妙应用"><a href="#关于链表的一些巧妙应用" class="headerlink" title="关于链表的一些巧妙应用"></a>关于链表的一些巧妙应用</h3><ul>
<li>偷懒：至于什么判断链表是不是为空，链表节点个数，或者查找链表中某个元素是否存在的函数，我就懒得介绍了。接下来看几个有趣的应用。</li>
</ul>
<hr>
<h5 id="如何判断单链表是否存在自环"><a href="#如何判断单链表是否存在自环" class="headerlink" title="如何判断单链表是否存在自环"></a>如何判断单链表是否存在自环</h5><ul>
<li>这是前两年大公司非常喜欢问的一道题目，何谓自环？就是在链表中形成了一个循环。</li>
<li>对于这个问题，有一个很棒的思路， <strong>那就是采用两个指针，一个指针从head开始，另一个从head-&gt;next开始，第一个指针每次只走一步，第二个指针每次走两步。正常不存在环的情况下，以第二个指针到达尾节点作为判断的依据，若是存在环，那必定这两个指针会相遇，那么指针相遇便能作为判断单链表中存在环的依据。</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//判断单链表中是否存在自环 1代表存在，0则反之。</span></div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">judge_circle</span><span class="params">(Node *head)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!head || !head-&gt;next) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    Node *first = head-&gt;next, *second = head-&gt;next-&gt;next;</div><div class="line">    <span class="keyword">while</span> (second &amp;&amp; first) &#123;</div><div class="line">        <span class="keyword">if</span> (first == second) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        second = second-&gt;next-&gt;next;</div><div class="line">        first = first-&gt;next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>该算法的时间复杂度是<strong>O(n)</strong>的。也就是最多只会遍历一次链表。附上Leetcode题目地址：<a href="https://leetcode.com/problems/linked-list-cycle/" target="_blank" rel="external">https://leetcode.com/problems/linked-list-cycle/</a></li>
</ul>
<hr>
<h3 id="翻转整条单链表"><a href="#翻转整条单链表" class="headerlink" title="翻转整条单链表"></a>翻转整条单链表</h3><ul>
<li>操作结果便是将 1-&gt;2-&gt;3-&gt;4-&gt;NULL 转换为 4-&gt;3-&gt;2-&gt;1-&gt;NULL.</li>
<li>思路很简单，无非就是指针操作，采用两个指针反复修改指向就可以了。Leetcode题目地址：<a href="https://leetcode.com/problems/reverse-linked-list/" target="_blank" rel="external">https://leetcode.com/problems/reverse-linked-list/</a></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//翻转整条链表,时间复杂度为O(n)</span></div><div class="line"><span class="function"><span class="keyword">inline</span> Node *<span class="title">reverse</span><span class="params">(Node *head)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!head || !head-&gt;next) <span class="keyword">return</span> head;</div><div class="line">    Node *pNode = head, *qNode = pNode-&gt;next;</div><div class="line">    pNode-&gt;next = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (!qNode-&gt;next) &#123;</div><div class="line">        head = qNode;</div><div class="line">        qNode-&gt;next = pNode;</div><div class="line">        <span class="keyword">return</span> head;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (qNode-&gt;next) &#123;</div><div class="line">        head = qNode-&gt;next;</div><div class="line">        qNode-&gt;next = pNode;</div><div class="line">        pNode = qNode;</div><div class="line">        qNode = head;</div><div class="line">    &#125;</div><div class="line">    head-&gt;next = pNode;</div><div class="line">    <span class="keyword">return</span> head;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>总结：先记录这么多吧，还有些题目暂时还没时间去整理出来。接下来有时间会持续更新。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="/2016/06/08/为什么我选择使用Blocks/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Liuxi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Shawenlx">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Shawenlx" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/08/为什么我选择使用Blocks/" itemprop="url">
                  为什么我选择使用Blocks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-08T21:00:00+08:00">
                2016-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/06/08/为什么我选择使用Blocks/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/08/为什么我选择使用Blocks/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>扯淡：到了新公司接手新框架之后，发现大量的使用Blocks，之前很多时候都是使用代理，突然面对这个陌生的语法，特地科普总结了一番。</li>
</ul>
<hr>
<h3 id="什么是Blocks"><a href="#什么是Blocks" class="headerlink" title="什么是Blocks"></a>什么是Blocks</h3><ul>
<li>一句话概括就是，带有局部变量的匿名函数（即不带名称的函数）。也称为<strong>闭包</strong>。</li>
</ul>
<h3 id="Blocks语法"><a href="#Blocks语法" class="headerlink" title="Blocks语法"></a>Blocks语法</h3><ul>
<li><strong> ^ </strong>返回值类型 参数列表 <strong>表达式</strong></li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//例如</span></div><div class="line">^<span class="keyword">int</span> (<span class="keyword">int</span> count) &#123; <span class="keyword">return</span> count + <span class="number">1</span>; &#125;</div></pre></td></tr></table></figure>
<ul>
<li>上述表达式中，返回值类型 以及 参数列表可以省略(如下), 语法加粗表明不可缺少的部分。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">^ &#123;</div><div class="line">      printf(<span class="string">"Hello, blocks"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="将Blocks声明为属性"><a href="#将Blocks声明为属性" class="headerlink" title="将Blocks声明为属性"></a>将Blocks声明为属性</h3><ul>
<li><p>多数情况下，我们会把Blocks声明为属性，便于调用。可以利用关键字typedef 对Blocks进行别名。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> 返回值类型 (^Blocks别名)(参数列表);</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> (^blk_t)(<span class="keyword">int</span>);</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//将Blocks声明为属性</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) blk_t blk;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//对Blocks进行声明定义</span></div><div class="line">blk = ^(<span class="keyword">int</span> count) &#123; <span class="keyword">return</span> count + <span class="number">1</span>; &#125;;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//调用Blocks 和 调用C语言声明函数方式一样</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d\n"</span>, blk(<span class="number">10</span>));</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="将Blocks作为参数传入方法中"><a href="#将Blocks作为参数传入方法中" class="headerlink" title="将Blocks作为参数传入方法中"></a>将Blocks作为参数传入方法中</h3><ul>
<li>通常都会事先为Blocks取一个别名，一来方便理解，好吧不装逼，就是偷懒。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义：</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^Block)(<span class="keyword">int</span> a);</div><div class="line">- (<span class="keyword">void</span>)nslogParameterWithBlock:(Block)block &#123; </div><div class="line">    <span class="keyword">if</span> (block) &#123; </div><div class="line">        block(<span class="number">10</span>); </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//赋值并调用</span></div><div class="line">[object nslogParameterWithBlock:^(<span class="keyword">int</span> a) &#123; </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, a);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<hr>
<h3 id="Blocks截获自动变量值"><a href="#Blocks截获自动变量值" class="headerlink" title="Blocks截获自动变量值"></a>Blocks截获自动变量值</h3><ul>
<li>什么是截获自动变量值，所谓自动变量，就是局部变量。那为什么会截获呢？先来看个例子。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> val = <span class="number">10</span>;</div><div class="line"><span class="keyword">void</span>  (^block)(<span class="keyword">void</span>) = ^ &#123; printf(<span class="string">"val = %d"</span>, val); &#125;;</div><div class="line">val = <span class="number">20</span>;</div><div class="line">block();  <span class="comment">//此处调用block，打印为val = 10；</span></div></pre></td></tr></table></figure>
<ul>
<li>之所以没有打印val = 20，是因为该Blocks在编译期就进行了初始化，对声明的val进行截获，也就是说，把val拷贝一份存入Blocks中。所以当外部val进行了修改时，不影响Blocks截获的val值。</li>
</ul>
<hr>
<h3 id="block-关键字"><a href="#block-关键字" class="headerlink" title="__block 关键字"></a>__block 关键字</h3><ul>
<li>从上个例子中，我们知道Blocks会对变量进行截获。那如果我非要在Blocks中修改外部参数怎么办呢？我们可以通过__block关键字做到！</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">__block <span class="keyword">int</span> val = <span class="number">10</span>;</div><div class="line"><span class="keyword">void</span>  (^block)(<span class="keyword">void</span>) = ^ &#123; printf(<span class="string">"val = %d"</span>, val); &#125;;</div><div class="line">val = <span class="number">20</span>;</div><div class="line">block();  <span class="comment">//此处调用block，打印为val = 20;</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>通过__block说明符对外部参数进行声明后，实际上，相当于在声明定义Blocks的时候，不是通过拷贝内存的方式拷贝外部参数，而是通过指针指向该外部变量，从而达到可以在Blocks中修改的效果。</strong></li>
</ul>
<hr>
<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><ul>
<li>Blocks使用方便，但是block的内存管理确实是一项非常重要也非常容易出错的地方，稍不注意便会造成内存泄露，所以，在使用Blocks的时候，也要小心。</li>
<li>因为是匿名函数，所以在项目中多人合作的时候，最后写上每个Blocks的注释说明。</li>
<li>后续将继续总结Blocks的内存管理内容。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="/2016/06/06/iOS-UICollectionView瀑布流/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Liuxi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Shawenlx">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Shawenlx" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/06/iOS-UICollectionView瀑布流/" itemprop="url">
                  iOS UICollectionView瀑布流
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-06T21:25:00+08:00">
                2016-06-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/06/06/iOS-UICollectionView瀑布流/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/06/iOS-UICollectionView瀑布流/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、UICollectionViewLayout基础知识"><a href="#一、UICollectionViewLayout基础知识" class="headerlink" title="一、UICollectionViewLayout基础知识"></a>一、UICollectionViewLayout基础知识</h3><ul>
<li>如果要自定义UICollectionViewLayout，需要实现以下几个方法，按初始化layout后，系统执行顺序排列：</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始化layout后自动调动，可以在该方法中初始化一些自定义的变量参数</span></div><div class="line">  - (<span class="keyword">void</span>)prepareLayout;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 设置UICollectionView的内容大小，道理与UIScrollView的contentSize类似</span></div><div class="line">  - (<span class="built_in">CGSize</span>)collectionViewContentSize;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始Layout外观，返回所有的布局属性</span></div><div class="line">  - (<span class="built_in">NSArray</span> *)layoutAttributesForElementsInRect:(<span class="built_in">CGRect</span>)rect;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 根据不同的indexPath，给出布局 </span></div><div class="line">  - (<span class="built_in">UICollectionViewLayoutAttributes</span> *)layoutAttributesForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</div></pre></td></tr></table></figure>
<h3 id="二、瀑布流布局"><a href="#二、瀑布流布局" class="headerlink" title="二、瀑布流布局"></a>二、瀑布流布局</h3><ul>
<li>逻辑与原理</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">逻辑其实很简单，就是给出每一个cell的坐标。想要定位一个控件，需要<span class="built_in">CGRectMake</span>四个参数：</div><div class="line"></div><div class="line">y : 首先我们看到的这个demo是两列的，所以肯定有两个Y轴起始点，分为左侧和右侧。</div><div class="line">x : 然后除Y轴不同外，左侧和右侧的X轴也不相同。</div><div class="line">width : 关于width我们可以通过一行两列，然后每一个cell的间距来得到。</div><div class="line">height: height是在collectionView中定义的，layout获得不到，所以我们选择用代理，在collectionView中设置。</div></pre></td></tr></table></figure>
<ul>
<li>需要的定义的变量</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span>   leftY;       <span class="comment">// 左侧起始Y轴</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span>   rightY;      <span class="comment">// 右侧起始Y轴</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> cellCount;   <span class="comment">// cell个数</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span>   itemWidth;   <span class="comment">// cell宽度</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span>   insert;      <span class="comment">// 间距</span></div></pre></td></tr></table></figure>
<ul>
<li>代理的定义</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@class</span> <span class="title">WaterfallFlowLayout</span>;</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">WaterfallFlowLayoutDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@required</span></div><div class="line">- (<span class="built_in">CGSize</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView collectionViewLayout:(sWaterfallFlowLayout *)collectionViewLayout sizeOfItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<ul>
<li>布局方法的实现</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *  初始化layout后自动调动，可以在该方法中初始化一些自定义的变量参数</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)prepareLayout &#123;</div><div class="line">    [<span class="keyword">super</span> prepareLayout];</div><div class="line">    </div><div class="line">    <span class="comment">// 初始化参数</span></div><div class="line">    _cellCount = [<span class="keyword">self</span>.collectionView numberOfItemsInSection:<span class="number">0</span>]; <span class="comment">// cell个数，直接从collectionView中获得</span></div><div class="line">    _insert = <span class="number">10</span>; <span class="comment">// 设置间距</span></div><div class="line">    _itemWidth = (SCREEN_WIDTH - <span class="number">3</span> * _insert) / <span class="number">2</span>; <span class="comment">// cell宽度</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  设置UICollectionView的内容大小，道理与UIScrollView的contentSize类似</div><div class="line"> *  @return 返回设置的UICollectionView的内容大小</div><div class="line"> */</div><div class="line">- (<span class="built_in">CGSize</span>)collectionViewContentSize &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="built_in">CGSizeMake</span>(SCREEN_WIDTH, MAX(_leftY, _rightY));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  初始Layout外观</div><div class="line"> *  @param rect 所有元素的布局属性</div><div class="line"> *  @return 所有元素的布局</div><div class="line"> */</div><div class="line">- (<span class="built_in">NSArray</span> *)layoutAttributesForElementsInRect:(<span class="built_in">CGRect</span>)rect &#123;</div><div class="line">    </div><div class="line">    _leftY = _insert; <span class="comment">// 左边起始Y轴</span></div><div class="line">    _rightY = _insert; <span class="comment">// 右边起始Y轴</span></div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *attributes = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">self</span>.cellCount; i ++) &#123;</div><div class="line">        <span class="built_in">NSIndexPath</span> *indexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:i inSection:<span class="number">0</span>];</div><div class="line">        [attributes addObject:[<span class="keyword">self</span> layoutAttributesForItemAtIndexPath:indexPath]];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> attributes;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  根据不同的indexPath，给出布局</div><div class="line"> *  @param indexPath</div><div class="line"> *  @return </div><div class="line"> */</div><div class="line">- (<span class="built_in">UICollectionViewLayoutAttributes</span> *)layoutAttributesForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</div><div class="line">    </div><div class="line">    <span class="comment">// 获取代理中返回的每一个cell的大小</span></div><div class="line">    <span class="built_in">CGSize</span> itemSize = [<span class="keyword">self</span>.delegate collectionView:<span class="keyword">self</span>.collectionView collectionViewLayout:<span class="keyword">self</span> sizeOfItemAtIndexPath:indexPath];</div><div class="line">    </div><div class="line">    <span class="comment">// 防止代理中给的size.width大于(或小于)layout中定义的width，所以等比例缩放size</span></div><div class="line">    <span class="built_in">CGFloat</span> itemHeight = floorf(itemSize.height * <span class="keyword">self</span>.itemWidth / itemSize.width);</div><div class="line">    </div><div class="line">    <span class="built_in">UICollectionViewLayoutAttributes</span> *attributes = [<span class="built_in">UICollectionViewLayoutAttributes</span> layoutAttributesForCellWithIndexPath:indexPath];</div><div class="line">    </div><div class="line">    <span class="comment">// 判断当前的item应该在左侧还是右侧</span></div><div class="line">    <span class="built_in">BOOL</span> isLeft = _leftY &lt; _rightY;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (isLeft) &#123;</div><div class="line">        <span class="built_in">CGFloat</span> x = _insert;</div><div class="line">        attributes.frame = <span class="built_in">CGRectMake</span>(x, _leftY, _itemWidth, itemHeight);</div><div class="line">        _leftY += itemHeight + _insert; <span class="comment">// 设置新的Y起点</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">CGFloat</span> x = _itemWidth + <span class="number">2</span> * _insert;</div><div class="line">        attributes.frame = <span class="built_in">CGRectMake</span>(x, _rightY, _itemWidth, itemHeight);</div><div class="line">        _rightY += itemHeight + _insert;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> attributes;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Demo地址"><a href="#Demo地址" class="headerlink" title="Demo地址"></a>Demo地址</h3><p><a href="https://github.com/shawenlx/WaterfallFlowCollection" target="_blank" rel="external">https://github.com/shawenlx/WaterfallFlowCollection</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Liuxi" />
          <p class="site-author-name" itemprop="name">Liuxi</p>
          <p class="site-description motion-element" itemprop="description">I love code and share.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liuxi</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"shawenlx"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
